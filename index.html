<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>spoodblort bookie tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./localstorage.js"></script>
    <script src="./table.js"></script>
    <style>
        * { font-family: sans-serif; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
    <header class="border-b border-gray-800 bg-gray-900/80 backdrop-blur sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <h1 class="text-xl font-bold">spoodblort bookie tools</h1>
            <nav class="flex items-center gap-2">
                <button data-route="today" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800" aria-current="page">today's matchups</button>
                <button data-route="fights" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800">fights</button>
                <button data-route="fighters" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800">fighters</button>
                <button data-route="odds" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800">odds</button>
            </nav>
        </div>
    </header>

    <main id="app" class="max-w-7xl mx-auto px-4 py-6">
        <div id="status" class="text-sm text-gray-400"></div>
        <div id="view" class="mt-4"></div>
        </main>

    <template id="table-template">
        <div class="overflow-auto rounded-lg border border-gray-800">
            <table class="min-w-full text-left text-sm">
                <thead class="bg-gray-900/70 text-gray-300 sticky top-0">
                    <tr id="thead-row"></tr>
                </thead>
                <tbody id="tbody" class="divide-y divide-gray-800 bg-gray-900/40"></tbody>
            </table>
    </div>
    </template>

    <script>
        const $ = (sel, el = document) => el.querySelector(sel);
        const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        const ROUTES = {
            today: 'today',
            fights: 'fights',
            fighters: 'fighters',
            odds: 'odds',
        };

        async function fetchJson(url) {
            const start = performance.now();
            let res;
            try {
                res = await fetch(url);
            } catch (e) {
                return { ok: false, status: 0, data: null, error: e?.message || 'network error', ms: performance.now() - start };
            }
            const ms = performance.now() - start;
            if (!res.ok) {
                let errText = '';
                try { errText = await res.text(); } catch {}
                return { ok: false, status: res.status, data: null, error: errText || `http ${res.status}` , ms };
            }
            try {
                const data = await res.json();
                return { ok: true, status: res.status, data, error: null, ms };
            } catch (e) {
                return { ok: false, status: res.status, data: null, error: 'invalid json', ms };
            }
        }


        function setStatus(message) {
            const el = $('#status');
            el.textContent = message || '';
        }

        function setView(node) {
            const view = $('#view');
            view.innerHTML = '';
            if (node) view.appendChild(node);
        }

        function renderTable(headers, rows) {
            const tpl = $('#table-template');
            const root = tpl.content.cloneNode(true);
            const theadRow = $('#thead-row', root);
            const tbody = $('#tbody', root);
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'px-3 py-2 font-semibold';
                th.textContent = h;
                theadRow.appendChild(th);
            });
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-800/50';
                r.forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'px-3 py-2 align-top text-gray-200';
                    if (cell instanceof Node) td.appendChild(cell); else td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            const container = document.createElement('div');
            container.appendChild(root);
            const table = container.querySelector('table');
            if (window.tableSort && table) {
                window.tableSort.makeTableSortable(table);
            }
            return container;
        }

        function formatTime(s) {
            if (!s) return '';
            try { return new Date(s).toLocaleString(); } catch { return s; }
        }

        const STAT_KEYS = ['Strength','Speed','Endurance','Technique'];

        function getFighterByIdOrName(id, name) {
            if (id != null && fightersCache.byId.has(id)) return fightersCache.byId.get(id);
            if (name) {
                const lc = String(name).toLowerCase();
                const found = fightersCache.raw.find(f => String(f.Name || '').toLowerCase() === lc);
                if (found) return found;
            }
            return null;
        }

        function safeNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }

        function computeStatWinProb(fA, fB) {
            let total = 0;
            let count = 0;
            STAT_KEYS.forEach(k => {
                const a = safeNum(fA?.[k]);
                const b = safeNum(fB?.[k]);
                if (a + b > 0) {
                    total += a / (a + b);
                    count += 1;
                }
            });
            if (count === 0) return 0.5;
            return total / count; 
        }

        function computeRecordBasedProb(fA, fB) {
            const aW = safeNum(fA?.Wins), aL = safeNum(fA?.Losses), aD = safeNum(fA?.Draws);
            const bW = safeNum(fB?.Wins), bL = safeNum(fB?.Losses), bD = safeNum(fB?.Draws);
            const aT = aW + aL + aD; const bT = bW + bL + bD;
            const aRate = (aW + 0.5 * aD + 1) / (aT + 2);
            const bRate = (bW + 0.5 * bD + 1) / (bT + 2);
            const denom = aRate + bRate;
            if (!Number.isFinite(denom) || denom === 0) return 0.5;
            return aRate / denom;
        }

        function toAmericanOdds(p) {
            if (!Number.isFinite(p)) return '';
            const pc = Math.min(Math.max(p, 0.01), 0.99);
            const maxAbs = 10000;
            if (pc >= 0.5) {
                const raw = Math.round((pc / (1 - pc)) * 100);
                return `-${Math.min(raw, maxAbs)}`;
            } else {
                const raw = Math.round(((1 - pc) / pc) * 100);
                return `+${Math.min(raw, maxAbs)}`;
            }
        }

        function renderStatGrid(f) {
            const wrap = document.createElement('div');
            wrap.className = 'grid grid-cols-2 gap-2 mt-3';
            STAT_KEYS.forEach(k => {
                const box = document.createElement('div');
                box.className = 'bg-white/10 rounded-md p-2 text-center';
                const label = document.createElement('div'); label.className = 'text-xs text-gray-300 font-semibold'; label.textContent = k;
                const val = document.createElement('div'); val.className = 'text-lg font-bold'; val.textContent = String(f?.[k] ?? '');
                box.appendChild(label); box.appendChild(val); wrap.appendChild(box);
            });
            return wrap;
        }

        function renderStatProgress(fA, fB) {
            const wrap = document.createElement('div');
            wrap.className = 'mt-3 space-y-2';
            STAT_KEYS.forEach(k => {
                const a = safeNum(fA?.[k]);
                const b = safeNum(fB?.[k]);
                const total = a + b;
                const aPct = total > 0 ? (a / total) : 0.5;
                const bPct = 1 - aPct;
                const aLeads = a > b;
                const row = document.createElement('div');
                row.className = 'w-full';
                const label = document.createElement('div');
                label.className = 'text-xs text-gray-300 mb-1 font-semibold';
                label.textContent = k;
                const bar = document.createElement('div');
                bar.className = 'w-full h-6 bg-gray-800 rounded overflow-hidden border border-gray-700 flex';
                const aBar = document.createElement('div');
                aBar.style.width = `${(aPct*100).toFixed(1)}%`;
                aBar.className = `h-full flex items-center justify-end pr-2 text-xs font-bold ${aLeads ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
                aBar.textContent = `${a}`;
                const bBar = document.createElement('div');
                bBar.style.width = `${(bPct*100).toFixed(1)}%`;
                bBar.className = `h-full flex items-center justify-start pl-2 text-xs font-bold ${aLeads ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
                bBar.textContent = `${b}`;
                bar.appendChild(aBar);
                bar.appendChild(bBar);
                row.appendChild(label);
                row.appendChild(bar);
                wrap.appendChild(row);
            });
            return wrap;
        }

        function renderMatchupCard(fight, fA, fB) {
            const pStatA = computeStatWinProb(fA, fB);
            const pStatB = 1 - pStatA;
            const pRecA = computeRecordBasedProb(fA, fB);
            const pRecB = 1 - pRecA;

            const card = document.createElement('div');
            card.className = 'my-6 p-4 rounded-xl border border-gray-800 bg-gray-900/50';

            const header = document.createElement('div');
            header.className = 'mb-4 flex items-center justify-between text-sm text-gray-300';
            header.textContent = `#${fight.id} • ${formatTime(fight.scheduled_time)} • ${fight.status || ''}`;
            card.appendChild(header);

            const row = document.createElement('div');
            row.className = 'flex flex-col md:flex-row items-stretch md:items-start gap-4';

            const aCol = document.createElement('div');
            aCol.className = 'flex-1 bg-cyan-600/10 rounded-lg p-4 border border-cyan-700/30';
            const aName = document.createElement('div'); aName.className = 'text-xl font-bold'; aName.textContent = fA?.Name || fight.fighter1_name || `#${fight.fighter1_id}`;
            aCol.appendChild(aName);
            const aRec = document.createElement('div'); aRec.className = 'text-sm text-gray-400'; aRec.textContent = `${safeNum(fA?.Wins)}-${safeNum(fA?.Losses)}-${safeNum(fA?.Draws)}`;
            aCol.appendChild(aRec);
            aCol.appendChild(renderStatGrid(fA));

            const center = document.createElement('div');
            center.className = 'w-full md:w-56 bg-gray-800 rounded-lg p-4 text-center border border-gray-700';
            center.innerHTML = `
                <div class="text-gray-300 text-xs font-semibold">stat edge</div>
                <div class="text-3xl font-extrabold mt-1 ${pStatA >= pStatB ? 'text-cyan-300' : 'text-orange-300'}">${(Math.max(pStatA, pStatB) * 100).toFixed(1)}%</div>
                <div class="text-xs text-gray-400 mt-2">${pStatA >= pStatB ? (fA?.Name || 'F1') : (fB?.Name || 'F2')} favored</div>
                <div class="h-px bg-gray-700 my-3"></div>
                <div class="text-gray-300 text-xs font-semibold">record odds</div>
                <div class="mt-1 text-sm">
                    <div class="flex items-center justify-between"><span>${fA?.Name || 'F1'}</span><span>${(pRecA*100).toFixed(1)}% <span class="text-gray-400">(${toAmericanOdds(pRecA)})</span></span></div>
                    <div class="flex items-center justify-between mt-1"><span>${fB?.Name || 'F2'}</span><span>${(pRecB*100).toFixed(1)}% <span class="text-gray-400">(${toAmericanOdds(pRecB)})</span></span></div>
                </div>
            `;

            const bCol = document.createElement('div');
            bCol.className = 'flex-1 bg-orange-600/10 rounded-lg p-4 border border-orange-700/30';
            const bName = document.createElement('div'); bName.className = 'text-xl font-bold'; bName.textContent = fB?.Name || fight.fighter2_name || `#${fight.fighter2_id}`;
            bCol.appendChild(bName);
            const bRec = document.createElement('div'); bRec.className = 'text-sm text-gray-400'; bRec.textContent = `${safeNum(fB?.Wins)}-${safeNum(fB?.Losses)}-${safeNum(fB?.Draws)}`;
            bCol.appendChild(bRec);
            bCol.appendChild(renderStatGrid(fB));

            row.appendChild(aCol); row.appendChild(center); row.appendChild(bCol);
            card.appendChild(row);
            return card;
        }

        function renderHeadToHeadCard(fA, fB) {
            const pStatA = computeStatWinProb(fA, fB);
            const pStatB = 1 - pStatA;
            const pRecA = computeRecordBasedProb(fA, fB);
            const pRecB = 1 - pRecA;

            const card = document.createElement('div');
            card.className = 'my-6 p-6 rounded-xl border border-gray-800 bg-gray-900/60 shadow-lg';

            const row = document.createElement('div');
            row.className = 'grid md:grid-cols-3 gap-6 items-start';

            const aCol = document.createElement('div');
            aCol.className = 'bg-cyan-600/10 rounded-lg p-4 border border-cyan-700/30';
            const aName = document.createElement('div'); aName.className = 'text-xl font-bold'; aName.textContent = fA?.Name || 'Fighter A';
            const aRec = document.createElement('div'); aRec.className = 'text-sm text-gray-400'; aRec.textContent = `${safeNum(fA?.Wins)}-${safeNum(fA?.Losses)}-${safeNum(fA?.Draws)}`;
            aCol.appendChild(aName); aCol.appendChild(aRec);

            const center = document.createElement('div');
            center.className = 'bg-gray-800 rounded-lg p-5 text-center border border-gray-700';
            center.innerHTML = `
                <div class="text-gray-300 text-xs font-semibold">stat edge</div>
                <div class="text-3xl font-extrabold mt-1 ${pStatA >= pStatB ? 'text-cyan-300' : 'text-orange-300'}">${(Math.max(pStatA, pStatB) * 100).toFixed(1)}%</div>
                <div class="text-xs text-gray-400 mt-2">${pStatA >= pStatB ? (fA?.Name || 'F1') : (fB?.Name || 'F2')} favored</div>
                <div class="h-px bg-gray-700 my-3"></div>
                <div class="text-gray-300 text-xs font-semibold mb-2">record odds</div>
                <div class="space-y-1 text-sm">
                    <div class="flex items-center justify-between"><span>${fA?.Name || 'F1'}</span><span>${(pRecA*100).toFixed(1)}% <span class="text-gray-400">(${toAmericanOdds(pRecA)})</span></span></div>
                    <div class="flex items-center justify-between"><span>${fB?.Name || 'F2'}</span><span>${(pRecB*100).toFixed(1)}% <span class="text-gray-400">(${toAmericanOdds(pRecB)})</span></span></div>
                </div>
            `;
            center.appendChild(renderStatProgress(fA, fB));

            const bCol = document.createElement('div');
            bCol.className = 'bg-orange-600/10 rounded-lg p-4 border border-orange-700/30';
            const bName = document.createElement('div'); bName.className = 'text-xl font-bold'; bName.textContent = fB?.Name || 'Fighter B';
            const bRec = document.createElement('div'); bRec.className = 'text-sm text-gray-400'; bRec.textContent = `${safeNum(fB?.Wins)}-${safeNum(fB?.Losses)}-${safeNum(fB?.Draws)}`;
            bCol.appendChild(bName); bCol.appendChild(bRec);

            row.appendChild(aCol); row.appendChild(center); row.appendChild(bCol);
            card.appendChild(row);
            return card;
        }

        const fightersCache = {
            loaded: false,
            byId: new Map(),
            raw: [],
        };

        function ensureFightersCacheFromStore() {
            if (fightersCache.loaded) return fightersCache;
            const cached = window.store.getJSON('fighters');
            if (Array.isArray(cached)) {
                fightersCache.raw = cached;
                cached.forEach(f => fightersCache.byId.set(f.ID, f));
                fightersCache.loaded = true;
            }
            return fightersCache;
        }

        async function routeToday() {
            setStatus("rendering today's schedule from cache...");
            const data = window.store.getJSON('schedule_today');
            if (!data) {
                setView(renderTable(['info'], [["no cached schedule yet"]]));
                setStatus('');
                return;
            }

            const { meta, fights = [], error } = data || {};
            if (error) {
                setStatus(`warning: ${error}`);
            } else {
                setStatus('');
            }

            if (fights.length > 0) {
                ensureFightersCacheFromStore();
            }

            const metaBlock = document.createElement('div');
            metaBlock.className = 'mb-3 text-sm text-gray-400';
            if (meta) {
                metaBlock.textContent = `day ${meta.day || ''} (${meta.timezone || ''}) • now ${meta.now || ''}${meta.tournament_id ? ` • tournament ${meta.tournament_id}` : ''}`;
            }
            const container = document.createElement('div');
            container.appendChild(metaBlock);
            if (!fights.length) {
                container.appendChild(renderTable(['info'], [["no fights scheduled today"]]));
            } else {
                fights.forEach(f => {
                    const fA = getFighterByIdOrName(f.fighter1_id, f.fighter1_name);
                    const fB = getFighterByIdOrName(f.fighter2_id, f.fighter2_name);
                    container.appendChild(renderMatchupCard(f, fA, fB));
                });
            }
            setView(container);
            setStatus('');
        }

        function unwrapNullish(obj, key) {
            const v = obj?.[key];
            if (v && typeof v === 'object' && 'Valid' in v) {
                return v.Valid ? (('Int64' in v) ? v.Int64 : (('String' in v) ? v.String : (('Time' in v) ? v.Time : ''))) : '';
            }
            return v == null ? '' : v;
        }

        async function routeFights() {
            setStatus('rendering fights from cache...');
            const data = window.store.getJSON('fights');
            const arr = Array.isArray(data) ? data : [];
            ensureFightersCacheFromStore();
            const headers = ['ID', 'Tournament', 'Fighter 1', 'Fighter 2', 'Scheduled', 'Status', 'Winner', 'Completed At'];
            const rows = arr.map(x => {
                const f1 = x.Fighter1Name || fightersCache.byId.get(x.Fighter1ID)?.Name || String(x.Fighter1ID || '');
                const f2 = x.Fighter2Name || fightersCache.byId.get(x.Fighter2ID)?.Name || String(x.Fighter2ID || '');
                const winnerId = unwrapNullish(x, 'WinnerID');
                const winner = winnerId ? (fightersCache.byId.get(winnerId)?.Name || String(winnerId)) : '';
                const completedAt = unwrapNullish(x, 'CompletedAt');
                return [
                    String(x.ID),
                    String(x.TournamentID || ''),
                    f1,
                    f2,
                    formatTime(x.ScheduledTime),
                    x.Status || '',
                    winner,
                    formatTime(completedAt),
                ];
            });
            setView(renderTable(headers, rows));
            setStatus('');
        }

        async function routeFighters() {
            setStatus('rendering fighters from cache...');
            const data = window.store.getJSON('fighters');
            const arr = Array.isArray(data) ? data : [];
            const headers = ['ID', 'Name', 'Team', 'Class', 'Wins', 'Losses', 'Draws', 'Strength', 'Speed', 'Endurance', 'Technique'];
            const rows = arr.map(f => [
                String(f.ID), f.Name || '', f.Team || '', f.FighterClass || '',
                String(f.Wins ?? ''), String(f.Losses ?? ''), String(f.Draws ?? ''),
                String(f.Strength ?? ''), String(f.Speed ?? ''), String(f.Endurance ?? ''), String(f.Technique ?? ''),
            ]);
            setView(renderTable(headers, rows));
            setStatus('');
        }

        async function routeOdds() {
            setStatus('head-to-head odds');
            ensureFightersCacheFromStore();
            const arr = fightersCache.raw.slice().sort((a,b)=> String(a.Name||'').localeCompare(String(b.Name||'')));
            if (!arr.length) {
                setView(renderTable(['info'], [["no cached fighters yet"]]));
                setStatus('');
                return;
            }

            const wrap = document.createElement('div');
            const controls = document.createElement('div');
            controls.className = 'mb-4 flex flex-col md:flex-row gap-3';

            function buildSelect(labelText) {
                const group = document.createElement('label');
                group.className = 'flex-1';
                const label = document.createElement('div'); label.className = 'text-xs text-gray-400 mb-1'; label.textContent = labelText;
                const select = document.createElement('select');
                select.className = 'w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2';
                arr.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = String(f.ID);
                    opt.textContent = f.Name || `#${f.ID}`;
                    select.appendChild(opt);
                });
                group.appendChild(label); group.appendChild(select);
                return { group, select };
            }

            const aSel = buildSelect('fighter A');
            const bSel = buildSelect('fighter B');
            if (arr.length > 1) {
                const i1 = Math.floor(Math.random() * arr.length);
                let i2 = Math.floor(Math.random() * arr.length);
                if (i2 === i1) i2 = (i2 + 1) % arr.length;
                aSel.select.selectedIndex = i1;
                bSel.select.selectedIndex = i2;
            }
            controls.appendChild(aSel.group);
            controls.appendChild(bSel.group);
            wrap.appendChild(controls);

            const result = document.createElement('div');
            wrap.appendChild(result);

            function render() {
                const aId = Number(aSel.select.value);
                const bId = Number(bSel.select.value);
                const fA = fightersCache.byId.get(aId);
                const fB = fightersCache.byId.get(bId);
                result.innerHTML = '';
                if (fA && fB && aId !== bId) {
                    result.appendChild(renderHeadToHeadCard(fA, fB));
                } else {
                    result.appendChild(renderTable(['info'], [[aId === bId ? 'select two different fighters' : 'selection missing']]));
                }
            }

            aSel.select.addEventListener('change', render);
            bSel.select.addEventListener('change', render);
            render();

            setView(wrap);
            setStatus('');
        }

        function setActiveNav(route) {
            $$('.nav-btn').forEach(btn => {
                if (btn.dataset.route === route) {
                    btn.classList.add('bg-gray-800');
                    btn.setAttribute('aria-current', 'page');
                } else {
                    btn.classList.remove('bg-gray-800');
                    btn.removeAttribute('aria-current');
                }
            });
        }

        async function navigate(route) {
            const r = route || ROUTES.today;
            setActiveNav(r);
            history.replaceState({ route: r }, '', `#${r}`);
            if (r === ROUTES.today) return routeToday();
            if (r === ROUTES.fights) return routeFights();
            if (r === ROUTES.fighters) return routeFighters();
            if (r === ROUTES.odds) return routeOdds();
        }

        $$('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.route)));

        async function prefetchAll() {
            setStatus('prefetching data...');
            try {
                const [fightersRes, fightsRes, scheduleRes] = await Promise.all([
                    fetchJson('https://spoodblort.com/api/fighters'),
                    fetchJson('https://spoodblort.com/api/fights'),
                    fetchJson('https://spoodblort.com/api/schedule/today'),
                ]);
                if (fightersRes.ok && Array.isArray(fightersRes.data)) window.store.setJSON('fighters', fightersRes.data);
                if (fightsRes.ok && Array.isArray(fightsRes.data)) window.store.setJSON('fights', fightsRes.data);
                if (scheduleRes.ok && scheduleRes?.data && typeof scheduleRes.data === 'object') window.store.setJSON('schedule_today', scheduleRes.data);
                ensureFightersCacheFromStore();
            } catch (_) {
            } finally {
                setStatus('');
            }
        }

        (async function init() {
            await prefetchAll();
            const initial = (location.hash || '#today').slice(1);
            navigate(initial);
        })();
    </script>
</body>
</html>

