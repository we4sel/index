<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> üêôThe Feature Creep's ü•äSPOODBLORT bookie tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./localstorage.js"></script>
    <script src="./table.js"></script>
    <script src="./draft.js"></script>
    <script src="./timer.js"></script>
    <style>
        * { font-family: sans-serif; }
        /* Draft pick pop effect */
        @keyframes pick-pop {
            0% { transform: scale(0.96); filter: drop-shadow(0 0 0 rgba(163,230,53,0)); opacity: 0.0; }
            25% { transform: scale(1.06); filter: drop-shadow(0 0 18px rgba(163,230,53,0.45)); opacity: 1; }
            60% { transform: scale(1.00); filter: drop-shadow(0 0 10px rgba(163,230,53,0.25)); }
            100% { transform: scale(1.00); filter: drop-shadow(0 0 0 rgba(163,230,53,0)); }
        }
        .pick-pop { animation: pick-pop 900ms cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* Live draft gravitas */
        @keyframes pick-shine {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes pick-ripple {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.08); }
        }
        .pick-impact {
            position: relative;
            overflow: hidden;
            animation: pick-pop 900ms cubic-bezier(0.25, 0.85, 0.25, 1) both, pick-shine 900ms ease-out both;
            background-image: linear-gradient(120deg, rgba(34,197,94,0) 0%, rgba(34,197,94,0.22) 30%, rgba(34,197,94,0) 60%);
            background-size: 200% 100%;
            box-shadow: 0 0 0 rgba(34,197,94,0);
        }
        .pick-impact:after {
            content: "";
            position: absolute;
            inset: -2px;
            border: 2px solid rgba(34,197,94,0.45);
            border-radius: 0.5rem;
            filter: drop-shadow(0 0 14px rgba(34,197,94,0.45));
            animation: pick-ripple 900ms ease-out forwards;
            pointer-events: none;
        }
        /* Full-page confetti overlay */
        .confetti-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 9999; overflow: hidden; }
        .confetti-piece { position: absolute; will-change: transform, opacity; border-radius: 1px; }
        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0); opacity: 1; }
            100% { transform: translateY(130vh) rotate(720deg); opacity: 0; }
        }

        /* Timer effects */
        @keyframes timer-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.04); }
            100% { transform: scale(1); }
        }
        @keyframes timer-flash {
            0% { box-shadow: 0 0 0 rgba(56,189,248,0); }
            30% { box-shadow: 0 0 32px rgba(56,189,248,0.45); }
            100% { box-shadow: 0 0 0 rgba(56,189,248,0); }
        }
        .timer-urgent .timer-digits { color: #f87171; text-shadow: 0 0 14px rgba(248,113,113,0.45); animation: timer-pulse 800ms ease-in-out infinite; }
        .timer-flash { animation: timer-flash 600ms ease-out; }
        .fit-glow { color: #a7f3d0 !important; text-shadow: 0 0 10px rgba(45,212,191,0.55); }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
    <header class="border-b border-gray-800 bg-gray-900/80 backdrop-blur">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <h1 class="text-xl font-bold">üêôThe Feature Creep's ü•äSPOODBLORT bookie tools</h1>
            <nav class="flex items-center gap-2">
                <button data-route="today" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800" aria-current="page">today's matchups</button>
                <button data-route="fights" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800">fights</button>
                <button data-route="fighters" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800">fighters</button>
                <button data-route="odds" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800">odds</button>
                <button data-route="teams" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800">teams</button>
                <button data-route="draft" class="nav-btn px-3 py-2 rounded-md text-sm font-semibold hover:bg-gray-800">draft</button>
            </nav>
        </div>
    </header>

    <main id="app" class="max-w-7xl mx-auto px-4 py-6">
        <div id="status" class="text-sm text-gray-400"></div>
        <div id="view" class="mt-4"></div>
        </main>

    <template id="table-template">
        <div class="overflow-auto rounded-lg border border-gray-800">
            <table class="min-w-full text-left text-sm">
                <thead class="bg-gray-900/70 text-gray-300 sticky top-0">
                    <tr id="thead-row"></tr>
                </thead>
                <tbody id="tbody" class="divide-y divide-gray-800 bg-gray-900/40"></tbody>
            </table>
    </div>
    </template>

    <script>
        const $ = (sel, el = document) => el.querySelector(sel);
        const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        const ROUTES = {
            today: 'today',
            fights: 'fights',
            fighters: 'fighters',
            odds: 'odds',
            teams: 'teams',
            draft: 'draft',
        };

        async function fetchJson(url) {
            const start = performance.now();
            let res;
            try {
                res = await fetch(url);
            } catch (e) {
                return { ok: false, status: 0, data: null, error: e?.message || 'network error', ms: performance.now() - start };
            }
            const ms = performance.now() - start;
            if (!res.ok) {
                let errText = '';
                try { errText = await res.text(); } catch {}
                return { ok: false, status: res.status, data: null, error: errText || `http ${res.status}` , ms };
            }
            try {
                const data = await res.json();
                return { ok: true, status: res.status, data, error: null, ms };
            } catch (e) {
                return { ok: false, status: res.status, data: null, error: 'invalid json', ms };
            }
        }


        function setStatus(message) {
            const el = $('#status');
            el.textContent = message || '';
        }

        function setView(node) {
            const view = $('#view');
            view.innerHTML = '';
            if (node) view.appendChild(node);
        }

        function renderTable(headers, rows) {
            const tpl = $('#table-template');
            const root = tpl.content.cloneNode(true);
            const theadRow = $('#thead-row', root);
            const tbody = $('#tbody', root);
            headers.forEach(h => {
                const th = document.createElement('th');
                th.className = 'px-3 py-2 font-semibold';
                th.textContent = h;
                theadRow.appendChild(th);
            });
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-800/50';
                r.forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'px-3 py-2 align-top text-gray-200';
                    if (cell instanceof Node) td.appendChild(cell); else td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            const container = document.createElement('div');
            container.appendChild(root);
            const table = container.querySelector('table');
            if (window.tableSort && table) {
                window.tableSort.makeTableSortable(table);
            }
            return container;
        }

        function formatTime(s) {
            if (!s) return '';
            try { return new Date(s).toLocaleString(); } catch { return s; }
        }

        const STAT_KEYS = ['Strength','Speed','Endurance','Technique'];

        function getFighterByIdOrName(id, name) {
            if (id != null && fightersCache.byId.has(id)) return fightersCache.byId.get(id);
            if (name) {
                const lc = String(name).toLowerCase();
                const found = fightersCache.raw.find(f => String(f.Name || '').toLowerCase() === lc);
                if (found) return found;
            }
            return null;
        }

        function safeNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }

        function computeStatWinProb(fA, fB) {
            let total = 0;
            let count = 0;
            STAT_KEYS.forEach(k => {
                const a = safeNum(fA?.[k]);
                const b = safeNum(fB?.[k]);
                if (a + b > 0) {
                    total += a / (a + b);
                    count += 1;
                }
            });
            if (count === 0) return 0.5;
            return total / count; 
        }

        function computeRecordBasedProb(fA, fB) {
            const aW = safeNum(fA?.Wins), aL = safeNum(fA?.Losses), aD = safeNum(fA?.Draws);
            const bW = safeNum(fB?.Wins), bL = safeNum(fB?.Losses), bD = safeNum(fB?.Draws);
            const aT = aW + aL + aD; const bT = bW + bL + bD;
            const aRate = (aW + 0.5 * aD + 1) / (aT + 2);
            const bRate = (bW + 0.5 * bD + 1) / (bT + 2);
            const denom = aRate + bRate;
            if (!Number.isFinite(denom) || denom === 0) return 0.5;
            return aRate / denom;
        }

        function computeTotalWinChance(fA, fB) {
            let total = 0;
            let samples = 0;
            STAT_KEYS.forEach(k => {
                const a = safeNum(fA?.[k]);
                const b = safeNum(fB?.[k]);
                const denom = a + b;
                total += denom > 0 ? (a / denom) : 0.5;
                samples += 1;
            });
            if (samples === 0) return 0.5;
            return total / samples;
        }

        function summarizeTeam(name, fighters) {
            const summary = {
                name,
                fighters: fighters.slice(),
                wins: 0,
                losses: 0,
                draws: 0,
                fights: 0,
                winRate: 0,
                avgStats: {},
            };
            const totals = { Strength: 0, Speed: 0, Endurance: 0, Technique: 0 };
            fighters.forEach(f => {
                const wins = safeNum(f?.Wins);
                const losses = safeNum(f?.Losses);
                const draws = safeNum(f?.Draws);
                summary.wins += wins;
                summary.losses += losses;
                summary.draws += draws;
                summary.fights += wins + losses + draws;
                STAT_KEYS.forEach(k => {
                    totals[k] += safeNum(f?.[k]);
                });
            });
            STAT_KEYS.forEach(k => {
                summary.avgStats[k] = fighters.length ? totals[k] / fighters.length : 0;
            });
            summary.winRate = summary.fights > 0 ? (summary.wins + 0.5 * summary.draws) / summary.fights : 0;
            summary.avgStatScore = STAT_KEYS.reduce((acc, k) => acc + (summary.avgStats[k] || 0), 0) / STAT_KEYS.length;
            summary.mvp = fighters.reduce((best, curr) => {
                const bestScore = best ? (safeNum(best.Wins) + 0.5 * safeNum(best.Draws)) : -Infinity;
                const currScore = safeNum(curr?.Wins) + 0.5 * safeNum(curr?.Draws);
                if (currScore > bestScore) return curr;
                if (currScore === bestScore) {
                    const bestAvg = best ? (STAT_KEYS.reduce((acc, k) => acc + safeNum(best?.[k]), 0) / STAT_KEYS.length) : -Infinity;
                    const currAvg = STAT_KEYS.reduce((acc, k) => acc + safeNum(curr?.[k]), 0) / STAT_KEYS.length;
                    if (currAvg > bestAvg) return curr;
                }
                return best;
            }, null);
            return summary;
        }

        function buildTeamCard(summary, options = {}) {
            const { highlight = false } = options;
            const card = document.createElement('section');
            card.className = 'rounded-xl border border-gray-800 bg-gray-900/60 p-5 shadow-md space-y-4';
            if (highlight) {
                card.classList.add('ring-2', 'ring-amber-400/60');
            }

            const header = document.createElement('div');
            header.className = 'flex flex-wrap items-center justify-between gap-3';

            const titleWrap = document.createElement('div');
            titleWrap.className = 'space-y-1';
            const title = document.createElement('h2');
            title.className = 'text-xl font-bold';
            title.textContent = summary.name;
            const subtitle = document.createElement('div');
            subtitle.className = 'text-sm text-gray-400';
            subtitle.textContent = `${summary.wins}-${summary.losses}-${summary.draws} ‚Ä¢ ${(summary.winRate * 100).toFixed(1)}% win rate ‚Ä¢ ${summary.fighters.length} fighters`;
            titleWrap.appendChild(title);
            titleWrap.appendChild(subtitle);
            header.appendChild(titleWrap);

            if (highlight) {
                const badge = document.createElement('span');
                badge.className = 'uppercase tracking-wide text-xs font-semibold bg-amber-500/15 text-amber-300 px-3 py-1 rounded-full';
                badge.textContent = 'best team';
                header.appendChild(badge);
            }

            const avgStatsRow = document.createElement('div');
            avgStatsRow.className = 'flex flex-wrap gap-2 text-xs text-gray-300';
            STAT_KEYS.forEach(k => {
                const chip = document.createElement('span');
                chip.className = 'px-2 py-1 rounded-md bg-white/5 border border-gray-800';
                chip.textContent = `${k.slice(0,3).toUpperCase()}: ${(summary.avgStats[k] || 0).toFixed(1)}`;
                avgStatsRow.appendChild(chip);
            });

            card.appendChild(header);
            card.appendChild(avgStatsRow);

            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto rounded-lg border border-gray-800';
            const table = document.createElement('table');
            table.className = 'min-w-full text-left text-sm';
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-900/70 text-gray-300';
            thead.innerHTML = `
                <tr>
                    <th class="px-3 py-2 font-semibold">fighter</th>
                    <th class="px-3 py-2 font-semibold">record</th>
                    <th class="px-3 py-2 font-semibold">strength</th>
                    <th class="px-3 py-2 font-semibold">speed</th>
                    <th class="px-3 py-2 font-semibold">endurance</th>
                    <th class="px-3 py-2 font-semibold">technique</th>
                </tr>
            `;
            const tbody = document.createElement('tbody');
            tbody.className = 'divide-y divide-gray-800';

            const rows = summary.fighters.slice().sort((a, b) => {
                const aWins = safeNum(a?.Wins);
                const bWins = safeNum(b?.Wins);
                if (bWins !== aWins) return bWins - aWins;
                return String(a?.Name || '').localeCompare(String(b?.Name || ''));
            });

            rows.forEach(f => {
                const tr = document.createElement('tr');
                const isMvp = summary.mvp && summary.mvp.ID === f.ID;
                tr.className = `hover:bg-gray-800/40 ${isMvp ? 'bg-green-600/10 border border-green-500/40' : ''}`;
                const record = `${safeNum(f?.Wins)}-${safeNum(f?.Losses)}-${safeNum(f?.Draws)}`;
                tr.innerHTML = `
                    <td class="px-3 py-2">${f?.Name || `#${f?.ID}`} ${isMvp ? '<span class="ml-2 text-xs font-bold uppercase text-green-300">captain</span>' : ''}</td>
                    <td class="px-3 py-2 text-gray-300">${record}</td>
                    <td class="px-3 py-2 text-gray-200">${safeNum(f?.Strength)}</td>
                    <td class="px-3 py-2 text-gray-200">${safeNum(f?.Speed)}</td>
                    <td class="px-3 py-2 text-gray-200">${safeNum(f?.Endurance)}</td>
                    <td class="px-3 py-2 text-gray-200">${safeNum(f?.Technique)}</td>
                `;
                tbody.appendChild(tr);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            if (window.tableSort && typeof window.tableSort.makeTableSortable === 'function') {
                window.tableSort.makeTableSortable(table);
            }
            card.appendChild(tableContainer);

            return card;
        }

        function toAmericanOdds(p) {
            if (!Number.isFinite(p)) return '';
            const pc = Math.min(Math.max(p, 0.01), 0.99);
            const maxAbs = 10000;
            if (pc >= 0.5) {
                const raw = Math.round((pc / (1 - pc)) * 100);
                return `-${Math.min(raw, maxAbs)}`;
            } else {
                const raw = Math.round(((1 - pc) / pc) * 100);
                return `+${Math.min(raw, maxAbs)}`;
            }
        }

        function renderStatGrid(f) {
            const wrap = document.createElement('div');
            wrap.className = 'grid grid-cols-2 gap-2 mt-3';
            STAT_KEYS.forEach(k => {
                const box = document.createElement('div');
                box.className = 'bg-white/10 rounded-md p-2 text-center';
                const label = document.createElement('div'); label.className = 'text-xs text-gray-300 font-semibold'; label.textContent = k;
                const val = document.createElement('div'); val.className = 'text-lg font-bold'; val.textContent = String(f?.[k] ?? '');
                box.appendChild(label); box.appendChild(val); wrap.appendChild(box);
            });
            return wrap;
        }

        function renderStatProgress(fA, fB) {
            const wrap = document.createElement('div');
            wrap.className = 'mt-3 space-y-2';
            STAT_KEYS.forEach(k => {
                const a = safeNum(fA?.[k]);
                const b = safeNum(fB?.[k]);
                const total = a + b;
                const aPct = total > 0 ? (a / total) : 0.5;
                const bPct = 1 - aPct;
                const aLeads = a > b;
                const row = document.createElement('div');
                row.className = 'w-full';
                const label = document.createElement('div');
                label.className = 'text-xs text-gray-300 mb-1 font-semibold';
                label.textContent = k;
                const bar = document.createElement('div');
                bar.className = 'w-full h-6 bg-gray-800 rounded overflow-hidden border border-gray-700 flex';
                const aBar = document.createElement('div');
                aBar.style.width = `${(aPct*100).toFixed(1)}%`;
                aBar.className = `h-full flex items-center justify-end pr-2 text-xs font-bold ${aLeads ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
                aBar.textContent = `${a}`;
                const bBar = document.createElement('div');
                bBar.style.width = `${(bPct*100).toFixed(1)}%`;
                bBar.className = `h-full flex items-center justify-start pl-2 text-xs font-bold ${aLeads ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
                bBar.textContent = `${b}`;
                bar.appendChild(aBar);
                bar.appendChild(bBar);
                row.appendChild(label);
                row.appendChild(bar);
                wrap.appendChild(row);
            });
            return wrap;
        }

        function renderMatchupCard(fight, fA, fB) {
            const pStatA = computeStatWinProb(fA, fB);
            const pStatB = 1 - pStatA;
            const pRecA = computeRecordBasedProb(fA, fB);
            const pRecB = 1 - pRecA;
            const pTotalA = computeTotalWinChance(fA, fB);
            const pTotalB = 1 - pTotalA;

            const card = document.createElement('div');
            card.className = 'my-6 p-4 rounded-xl border border-gray-800 bg-gray-900/50';

            const header = document.createElement('div');
            header.className = 'mb-4 flex items-center justify-between text-sm text-gray-300';
            header.textContent = `#${fight.id} ‚Ä¢ ${formatTime(fight.scheduled_time)} ‚Ä¢ ${fight.status || ''}`;
            card.appendChild(header);

            const row = document.createElement('div');
            row.className = 'flex flex-col md:flex-row items-stretch md:items-start gap-4';

            const aCol = document.createElement('div');
            aCol.className = 'flex-1 bg-cyan-600/10 rounded-lg p-4 border border-cyan-700/30';
            const aName = document.createElement('div'); aName.className = 'text-xl font-bold'; aName.textContent = fA?.Name || fight.fighter1_name || `#${fight.fighter1_id}`;
            aCol.appendChild(aName);
            const aRec = document.createElement('div'); aRec.className = 'text-sm text-gray-400'; aRec.textContent = `${safeNum(fA?.Wins)}-${safeNum(fA?.Losses)}-${safeNum(fA?.Draws)}`;
            aCol.appendChild(aRec);
            aCol.appendChild(renderStatGrid(fA));

            const center = document.createElement('div');
            center.className = 'w-full md:w-56 bg-gray-800 rounded-lg p-4 text-center border border-gray-700';
            center.innerHTML = `
                <div class="text-gray-300 text-xs font-semibold">stat edge</div>
                <div class="text-3xl font-extrabold mt-1 ${pStatA >= pStatB ? 'text-cyan-300' : 'text-orange-300'}">${(Math.max(pStatA, pStatB) * 100).toFixed(1)}%</div>
                <div class="text-xs text-gray-400 mt-2">${pStatA >= pStatB ? (fA?.Name || 'F1') : (fB?.Name || 'F2')} favored</div>
                <div class="h-px bg-gray-700 my-3"></div>
                <div class="text-gray-300 text-xs font-semibold">total win chance</div>
                <div class="mt-1 text-sm space-y-1">
                    <div class="flex items-center justify-between"><span>${fA?.Name || 'F1'}</span><span>${(pTotalA*100).toFixed(1)}%</span></div>
                    <div class="flex items-center justify-between"><span>${fB?.Name || 'F2'}</span><span>${(pTotalB*100).toFixed(1)}%</span></div>
                </div>
                <div class="h-px bg-gray-700 my-3"></div>
                <div class="text-gray-300 text-xs font-semibold">record odds</div>
                <div class="mt-1 text-sm">
                    <div class="flex items-center justify-between"><span>${fA?.Name || 'F1'}</span><span>${(pRecA*100).toFixed(1)}% <span class="text-gray-400">(${toAmericanOdds(pRecA)})</span></span></div>
                    <div class="flex items-center justify-between mt-1"><span>${fB?.Name || 'F2'}</span><span>${(pRecB*100).toFixed(1)}% <span class="text-gray-400">(${toAmericanOdds(pRecB)})</span></span></div>
                </div>
            `;

            const bCol = document.createElement('div');
            bCol.className = 'flex-1 bg-orange-600/10 rounded-lg p-4 border border-orange-700/30';
            const bName = document.createElement('div'); bName.className = 'text-xl font-bold'; bName.textContent = fB?.Name || fight.fighter2_name || `#${fight.fighter2_id}`;
            bCol.appendChild(bName);
            const bRec = document.createElement('div'); bRec.className = 'text-sm text-gray-400'; bRec.textContent = `${safeNum(fB?.Wins)}-${safeNum(fB?.Losses)}-${safeNum(fB?.Draws)}`;
            bCol.appendChild(bRec);
            bCol.appendChild(renderStatGrid(fB));

            row.appendChild(aCol); row.appendChild(center); row.appendChild(bCol);
            card.appendChild(row);
            return card;
        }

        function renderHeadToHeadCard(fA, fB, leftExtra, rightExtra) {
            const pStatA = computeStatWinProb(fA, fB);
            const pStatB = 1 - pStatA;
            const pRecA = computeRecordBasedProb(fA, fB);
            const pRecB = 1 - pRecA;
            const pTotalA = computeTotalWinChance(fA, fB);
            const pTotalB = 1 - pTotalA;

            const card = document.createElement('div');
            card.className = 'my-6 p-6 rounded-xl border border-gray-800 bg-gray-900/60 shadow-lg';

            const row = document.createElement('div');
            row.className = 'grid md:grid-cols-3 gap-6 items-start';

            const aCol = document.createElement('div');
            aCol.className = 'bg-cyan-600/10 rounded-lg p-4 border border-cyan-700/30';
            const aName = document.createElement('div'); aName.className = 'text-xl font-bold'; aName.textContent = fA?.Name || 'Fighter A';
            const aRec = document.createElement('div'); aRec.className = 'text-sm text-gray-400'; aRec.textContent = `${safeNum(fA?.Wins)}-${safeNum(fA?.Losses)}-${safeNum(fA?.Draws)}`;
            aCol.appendChild(aName); aCol.appendChild(aRec);
            if (leftExtra) aCol.appendChild(leftExtra);

            const center = document.createElement('div');
            center.className = 'bg-gray-800 rounded-lg p-5 text-center border border-gray-700';
            center.innerHTML = `
                <div class="text-gray-300 text-xs font-semibold">stat edge</div>
                <div class="text-3xl font-extrabold mt-1 ${pStatA >= pStatB ? 'text-cyan-300' : 'text-orange-300'}">${(Math.max(pStatA, pStatB) * 100).toFixed(1)}%</div>
                <div class="text-xs text-gray-400 mt-2">${pStatA >= pStatB ? (fA?.Name || 'F1') : (fB?.Name || 'F2')} favored</div>
                <div class="h-px bg-gray-700 my-3"></div>
                <div class="text-gray-300 text-xs font-semibold mb-2">total win chance</div>
                <div class="space-y-1 text-sm">
                    <div class="flex items-center justify-between"><span>${fA?.Name || 'F1'}</span><span>${(pTotalA*100).toFixed(1)}%</span></div>
                    <div class="flex items-center justify-between"><span>${fB?.Name || 'F2'}</span><span>${(pTotalB*100).toFixed(1)}%</span></div>
                </div>
                <div class="h-px bg-gray-700 my-3"></div>
                <div class="text-gray-300 text-xs font-semibold mb-2">record odds</div>
                <div class="space-y-1 text-sm">
                    <div class="flex items-center justify-between"><span>${fA?.Name || 'F1'}</span><span>${(pRecA*100).toFixed(1)}% <span class="text-gray-400">(${toAmericanOdds(pRecA)})</span></span></div>
                    <div class="flex items-center justify-between"><span>${fB?.Name || 'F2'}</span><span>${(pRecB*100).toFixed(1)}% <span class="text-gray-400">(${toAmericanOdds(pRecB)})</span></span></div>
                </div>
            `;
            center.appendChild(renderStatProgress(fA, fB));

            const bCol = document.createElement('div');
            bCol.className = 'bg-orange-600/10 rounded-lg p-4 border border-orange-700/30';
            const bName = document.createElement('div'); bName.className = 'text-xl font-bold'; bName.textContent = fB?.Name || 'Fighter B';
            const bRec = document.createElement('div'); bRec.className = 'text-sm text-gray-400'; bRec.textContent = `${safeNum(fB?.Wins)}-${safeNum(fB?.Losses)}-${safeNum(fB?.Draws)}`;
            bCol.appendChild(bName); bCol.appendChild(bRec);
            if (rightExtra) bCol.appendChild(rightExtra);

            row.appendChild(aCol); row.appendChild(center); row.appendChild(bCol);
            card.appendChild(row);
            return card;
        }

        function getRecentFightsFor(fighterId, limit) {
            const fights = window.store.getJSON('fights');
            const list = Array.isArray(fights) ? fights : [];
            const recent = list.filter(x => x.Fighter1ID === fighterId || x.Fighter2ID === fighterId)
                .sort((a,b) => new Date(b.ScheduledTime).getTime() - new Date(a.ScheduledTime).getTime())
                .slice(0, limit);
            return recent.map(f => {
                const isA = f.Fighter1ID === fighterId;
                const opponentId = isA ? f.Fighter2ID : f.Fighter1ID;
                const opponentName = isA ? (f.Fighter2Name || fightersCache.byId.get(opponentId)?.Name || `#${opponentId}`)
                                         : (f.Fighter1Name || fightersCache.byId.get(opponentId)?.Name || `#${opponentId}`);
                const winnerId = unwrapNullish(f, 'WinnerID');
                let outcome = '';
                if (winnerId) outcome = winnerId === fighterId ? 'W' : 'L';
                const when = f.CompletedAt && typeof f.CompletedAt === 'object' && f.CompletedAt.Valid ? f.CompletedAt.Time : f.ScheduledTime;
                return { id: f.ID, opponentId, opponentName, outcome, when };
            });
        }

        function renderRecentListFor(fighterId, side, onPick) {
            const items = getRecentFightsFor(fighterId, 7);
            const box = document.createElement('div');
            box.className = 'mt-4';
            const title = document.createElement('div');
            title.className = 'text-xs font-semibold text-gray-300 mb-2';
            title.textContent = 'recent fights';
            box.appendChild(title);
            const list = document.createElement('div');
            list.className = 'space-y-1';
            items.forEach(it => {
                const row = document.createElement('button');
                row.type = 'button';
                row.className = 'w-full text-left px-3 py-2 rounded bg-white/5 hover:bg-white/10 border border-gray-700 flex items-center justify-between';
                const left = document.createElement('span');
                left.className = `text-xs font-semibold ${it.outcome==='W' ? 'text-green-400' : (it.outcome==='L' ? 'text-red-400' : 'text-gray-300')}`;
                left.textContent = it.outcome || '‚Äî';
                const mid = document.createElement('span');
                mid.className = 'text-sm text-gray-200';
                mid.textContent = it.opponentName;
                const right = document.createElement('span');
                right.className = 'text-xs text-gray-400';
                right.textContent = formatTime(it.when);
                const leftWrap = document.createElement('div');
                leftWrap.className = 'flex items-center gap-3';
                leftWrap.appendChild(left); leftWrap.appendChild(mid);
                row.appendChild(leftWrap); row.appendChild(right);
                row.addEventListener('click', () => onPick(side, fighterId, it.opponentId));
                list.appendChild(row);
            });
            if (!items.length) {
                const empty = document.createElement('div');
                empty.className = 'text-xs text-gray-500';
                empty.textContent = 'no recent fights';
                list.appendChild(empty);
            }
            box.appendChild(list);
            return box;
        }

        const fightersCache = {
            loaded: false,
            byId: new Map(),
            raw: [],
        };

        function ensureFightersCacheFromStore() {
            if (fightersCache.loaded) return fightersCache;
            const cached = window.store.getJSON('fighters');
            if (Array.isArray(cached)) {
                fightersCache.raw = cached;
                cached.forEach(f => fightersCache.byId.set(f.ID, f));
                fightersCache.loaded = true;
            }
            return fightersCache;
        }

        async function routeToday() {
            setStatus("rendering today's schedule from cache...");
            const data = window.store.getJSON('schedule_today');
            if (!data) {
                setView(renderTable(['info'], [["no cached schedule yet"]]));
                setStatus('');
                return;
            }

            const { meta, fights = [], error } = data || {};
            if (error) {
                setStatus(`warning: ${error}`);
            } else {
                setStatus('');
            }

            if (fights.length > 0) {
                ensureFightersCacheFromStore();
            }

            const metaBlock = document.createElement('div');
            metaBlock.className = 'mb-3 text-sm text-gray-400';
            if (meta) {
                metaBlock.textContent = `day ${meta.day || ''} (${meta.timezone || ''}) ‚Ä¢ now ${meta.now || ''}${meta.tournament_id ? ` ‚Ä¢ tournament ${meta.tournament_id}` : ''}`;
            }
            const container = document.createElement('div');
            container.appendChild(metaBlock);
            if (!fights.length) {
                container.appendChild(renderTable(['info'], [["no fights scheduled today"]]));
            } else {
                fights.forEach(f => {
                    const fA = getFighterByIdOrName(f.fighter1_id, f.fighter1_name);
                    const fB = getFighterByIdOrName(f.fighter2_id, f.fighter2_name);
                    container.appendChild(renderMatchupCard(f, fA, fB));
                });
            }
            setView(container);
            setStatus('');
        }

        function unwrapNullish(obj, key) {
            const v = obj?.[key];
            if (v && typeof v === 'object' && 'Valid' in v) {
                return v.Valid ? (('Int64' in v) ? v.Int64 : (('String' in v) ? v.String : (('Time' in v) ? v.Time : ''))) : '';
            }
            return v == null ? '' : v;
        }

        async function routeFights() {
            setStatus('rendering fights from cache...');
            const data = window.store.getJSON('fights');
            const arr = Array.isArray(data) ? data : [];
            ensureFightersCacheFromStore();
            const headers = ['ID', 'Tournament', 'Fighter 1', 'Fighter 2', 'Scheduled', 'Status', 'Winner', 'Completed At'];
            const rows = arr.map(x => {
                const f1 = x.Fighter1Name || fightersCache.byId.get(x.Fighter1ID)?.Name || String(x.Fighter1ID || '');
                const f2 = x.Fighter2Name || fightersCache.byId.get(x.Fighter2ID)?.Name || String(x.Fighter2ID || '');
                const winnerId = unwrapNullish(x, 'WinnerID');
                const winner = winnerId ? (fightersCache.byId.get(winnerId)?.Name || String(winnerId)) : '';
                const completedAt = unwrapNullish(x, 'CompletedAt');
                return [
                    String(x.ID),
                    String(x.TournamentID || ''),
                    f1,
                    f2,
                    formatTime(x.ScheduledTime),
                    x.Status || '',
                    winner,
                    formatTime(completedAt),
                ];
            });
            setView(renderTable(headers, rows));
            setStatus('');
        }

        async function routeDraft() {
            setStatus('draft simulator');
            const root = document.createElement('div');
            setView(root);
            window.draft.renderDraftUI(root);
            setStatus('');
        }

        async function routeFighters() {
            setStatus('rendering fighters from cache...');
            const data = window.store.getJSON('fighters');
            const arr = Array.isArray(data) ? data : [];
            const headers = ['ID', 'Name', 'Team', 'Class', 'Wins', 'Losses', 'Draws', 'Strength', 'Speed', 'Endurance', 'Technique'];
            const rows = arr.map(f => [
                String(f.ID), f.Name || '', f.Team || '', f.FighterClass || '',
                String(f.Wins ?? ''), String(f.Losses ?? ''), String(f.Draws ?? ''),
                String(f.Strength ?? ''), String(f.Speed ?? ''), String(f.Endurance ?? ''), String(f.Technique ?? ''),
            ]);
            setView(renderTable(headers, rows));
            setStatus('');
        }

        async function routeTeams() {
            setStatus('teams overview');
            const data = window.store.getJSON('fighters');
            const fighters = Array.isArray(data) ? data : [];
            if (!fighters.length) {
                setView(renderTable(['info'], [["no cached fighters yet"]]));
                setStatus('');
                return;
            }

            const actualTeams = new Map();
            const freeAgents = [];
            const customFighters = [];

            fighters.forEach(f => {
                const teamRaw = (f.Team || '').trim();
                const lc = teamRaw.toLowerCase();
                const isFree = !teamRaw || lc === 'free agent' || lc === 'free agents' || lc === 'fa';
                const isCustom = lc === 'custom fighter' || lc === 'custom fighters' || lc === 'custom';
                if (isCustom) {
                    customFighters.push(f);
                } else if (isFree) {
                    freeAgents.push(f);
                } else {
                    if (!actualTeams.has(teamRaw)) actualTeams.set(teamRaw, []);
                    actualTeams.get(teamRaw).push(f);
                }
            });

            const teamSummaries = Array.from(actualTeams.entries()).map(([name, list]) => summarizeTeam(name, list));

            const container = document.createElement('div');
            container.className = 'space-y-6';

            const controlsBar = document.createElement('div');
            controlsBar.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3';

            const heading = document.createElement('div');
            heading.className = 'text-lg font-semibold text-gray-200';
            heading.textContent = 'team standings';
            controlsBar.appendChild(heading);

            const sortWrap = document.createElement('label');
            sortWrap.className = 'flex items-center gap-2 text-sm text-gray-300 bg-gray-900/60 border border-gray-800 rounded-lg px-3 py-2';
            const sortText = document.createElement('span');
            sortText.className = 'uppercase tracking-wide text-xs text-gray-400';
            sortText.textContent = 'sort by';
            const sortSelect = document.createElement('select');
            sortSelect.className = 'bg-transparent text-sm font-semibold focus:outline-none';
            [
                { value: 'winRate', label: 'Win rate (desc)' },
                { value: 'wins', label: 'Total wins (desc)' },
                { value: 'fights', label: 'Total fights (desc)' },
                { value: 'avgStat', label: 'Average stats (desc)' },
            ].forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                sortSelect.appendChild(option);
            });
            sortWrap.appendChild(sortText);
            sortWrap.appendChild(sortSelect);
            controlsBar.appendChild(sortWrap);
            container.appendChild(controlsBar);

            const cardsWrap = document.createElement('div');
            cardsWrap.className = 'space-y-6';
            container.appendChild(cardsWrap);

            function sortTeams(mode) {
                const sorted = teamSummaries.slice();
                sorted.sort((a, b) => {
                    if (mode === 'wins') {
                        if (b.wins !== a.wins) return b.wins - a.wins;
                        if (b.winRate !== a.winRate) return b.winRate - a.winRate;
                    } else if (mode === 'fights') {
                        if (b.fights !== a.fights) return b.fights - a.fights;
                        if (b.wins !== a.wins) return b.wins - a.wins;
                    } else if (mode === 'avgStat') {
                        if (b.avgStatScore !== a.avgStatScore) return b.avgStatScore - a.avgStatScore;
                        if (b.winRate !== a.winRate) return b.winRate - a.winRate;
                    } else {
                        if (b.winRate !== a.winRate) return b.winRate - a.winRate;
                        if (b.wins !== a.wins) return b.wins - a.wins;
                    }
                    return a.name.localeCompare(b.name);
                });
                return sorted;
            }

            function renderTeams() {
                const mode = sortSelect.value;
                const sorted = sortTeams(mode);
                cardsWrap.innerHTML = '';
                sorted.forEach((summary, index) => {
                    cardsWrap.appendChild(buildTeamCard(summary, { highlight: index === 0 }));
                });

                if (freeAgents.length) {
                    const summary = summarizeTeam('free agents', freeAgents);
                    cardsWrap.appendChild(buildTeamCard(summary));
                }

                if (customFighters.length) {
                    const summary = summarizeTeam('custom fighters', customFighters);
                    cardsWrap.appendChild(buildTeamCard(summary));
                }
            }

            sortSelect.addEventListener('change', renderTeams);
            renderTeams();

            setView(container);
            setStatus('');
        }

        async function routeOdds() {
            setStatus('head-to-head odds');
            ensureFightersCacheFromStore();
            const arr = fightersCache.raw.slice().sort((a,b)=> String(a.Name||'').localeCompare(String(b.Name||'')));
            if (!arr.length) {
                setView(renderTable(['info'], [["no cached fighters yet"]]));
                setStatus('');
                return;
            }

            const wrap = document.createElement('div');
            const controls = document.createElement('div');
            controls.className = 'mb-4 flex flex-col md:flex-row gap-3';

            function buildSelect(labelText) {
                const group = document.createElement('label');
                group.className = 'flex-1';
                const label = document.createElement('div'); label.className = 'text-xs text-gray-400 mb-1'; label.textContent = labelText;
                const select = document.createElement('select');
                select.className = 'w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2';
                arr.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = String(f.ID);
                    opt.textContent = f.Name || `#${f.ID}`;
                    select.appendChild(opt);
                });
                group.appendChild(label); group.appendChild(select);
                return { group, select };
            }

            const aSel = buildSelect('fighter A');
            const bSel = buildSelect('fighter B');
            if (arr.length > 1) {
                const i1 = Math.floor(Math.random() * arr.length);
                let i2 = Math.floor(Math.random() * arr.length);
                if (i2 === i1) i2 = (i2 + 1) % arr.length;
                aSel.select.selectedIndex = i1;
                bSel.select.selectedIndex = i2;
            }
            controls.appendChild(aSel.group);
            controls.appendChild(bSel.group);
            wrap.appendChild(controls);

            const result = document.createElement('div');
            wrap.appendChild(result);

            function render() {
                const aId = Number(aSel.select.value);
                const bId = Number(bSel.select.value);
                const fA = fightersCache.byId.get(aId);
                const fB = fightersCache.byId.get(bId);
                result.innerHTML = '';
                if (fA && fB && aId !== bId) {
                    const leftExtra = renderRecentListFor(aId, 'A', (side, fid, oppId) => {
                        if (fightersCache.byId.has(oppId)) {
                            if (side === 'A') { bSel.select.value = String(oppId); }
                            else { aSel.select.value = String(oppId); }
                            render();
                        }
                    });
                    const rightExtra = renderRecentListFor(bId, 'B', (side, fid, oppId) => {
                        if (fightersCache.byId.has(oppId)) {
                            if (side === 'B') { aSel.select.value = String(oppId); }
                            else { bSel.select.value = String(oppId); }
                            render();
                        }
                    });
                    result.appendChild(renderHeadToHeadCard(fA, fB, leftExtra, rightExtra));
                } else {
                    result.appendChild(renderTable(['info'], [[aId === bId ? 'select two different fighters' : 'selection missing']]));
                }
            }

            aSel.select.addEventListener('change', render);
            bSel.select.addEventListener('change', render);
            render();

            setView(wrap);
            setStatus('');
        }

        function setActiveNav(route) {
            $$('.nav-btn').forEach(btn => {
                if (btn.dataset.route === route) {
                    btn.classList.add('bg-gray-800');
                    btn.setAttribute('aria-current', 'page');
                } else {
                    btn.classList.remove('bg-gray-800');
                    btn.removeAttribute('aria-current');
                }
            });
        }

        async function navigate(route) {
            const r = route || ROUTES.today;
            setActiveNav(r);
            history.replaceState({ route: r }, '', `#${r}`);
            if (r === ROUTES.today) return routeToday();
            if (r === ROUTES.fights) return routeFights();
            if (r === ROUTES.fighters) return routeFighters();
            if (r === ROUTES.odds) return routeOdds();
            if (r === ROUTES.teams) return routeTeams();
            if (r === ROUTES.draft) return routeDraft();
        }

        $$('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.route)));

        async function prefetchAll() {
            setStatus('prefetching data...');
            try {
                const [fightersRes, fightsRes, scheduleRes] = await Promise.all([
                    fetchJson('https://spoodblort.com/api/fighters'),
                    fetchJson('https://spoodblort.com/api/fights'),
                    fetchJson('https://spoodblort.com/api/schedule/today'),
                ]);
                if (fightersRes.ok && Array.isArray(fightersRes.data)) window.store.setJSON('fighters', fightersRes.data);
                if (fightsRes.ok && Array.isArray(fightsRes.data)) window.store.setJSON('fights', fightsRes.data);
                if (scheduleRes.ok && scheduleRes?.data && typeof scheduleRes.data === 'object') window.store.setJSON('schedule_today', scheduleRes.data);
                ensureFightersCacheFromStore();
            } catch (_) {
            } finally {
                setStatus('');
            }
        }

        (async function init() {
            await prefetchAll();
            const initial = (location.hash || '#today').slice(1);
            navigate(initial);
        })();
    </script>
</body>
</html>

